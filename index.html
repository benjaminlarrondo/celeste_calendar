<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Calendario Custodia</title>
  <style>
    :root{
      --bg:#f7f7f8;
      --panel:#ffffff;
      --panel2:#f3f4f6;
      --text:#1f2937;
      --muted:#6b7280;
      --grid:#d1d5db;
      --mine:#f7d7dc;         /* rosa pastel */
      --hers:#f8efc6;         /* amarillo pastel */
      --neutral:#f2f4f7;
      --exception:#b7a3e8;    /* morado suave */
      --accent:#7cc9f7;       /* nota */
      --holiday:#f4b168;      /* feriado legal */
      --vacation:#77cba2;     /* vacaciones */
      --select:#94a3b8;
      --shadow: 0 4px 14px rgba(17,24,39,.06);
      --radius:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Liberation Sans", sans-serif;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      background: var(--bg);
      color:var(--text);
      font-family:var(--sans);
    }

    header{
      position:sticky; top:0;
      z-index:10;
      backdrop-filter: none;
      background: rgba(255,255,255,.95);
      border-bottom:1px solid #e5e7eb;
    }

    .wrap{
      max-width: 1200px;
      margin: 0 auto;
      padding: 18px 16px;
    }

    .topbar{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }

    .title{
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      gap:4px;
    }
    .titleLine{
      display:flex;
      align-items:baseline;
      gap:10px;
      flex-wrap:wrap;
    }
    .title h1{
      font-size: 18px; margin:0;
      letter-spacing:.2px;
    }
    .title small{
      color:var(--muted);
    }
    .baseMeta{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:12px;
      color:var(--muted);
      flex-wrap:wrap;
    }
    .baseMeta code{
      background: var(--panel2);
      border:1px solid #d1d5db;
      border-radius: 8px;
      padding: 2px 6px;
      color: var(--text);
      font-family: var(--mono);
      font-size: 11px;
    }
    .baseMeta a{
      color:#0f766e;
      text-decoration:none;
      border-bottom:1px solid #99f6e4;
    }
    .baseMeta a:hover{
      text-decoration:underline;
    }

    .controls{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
    }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid #d1d5db;
      border-radius:999px;
      background: #ffffff;
    }

    .chip b{ font-family:var(--mono); font-size:12px; }
    .dot{
      width:12px; height:12px; border-radius:4px;
      background: var(--neutral);
      border:1px solid #d1d5db;
    }
    .dot.mine{ background: var(--mine); }
    .dot.hers{ background: var(--hers); }
    .dot.exc{ background: var(--exception); }
    .dot.holiday{ background: var(--holiday); }
    .dot.vacation{ background: var(--vacation); }

    button, select, input[type="number"]{
      background: #ffffff;
      border:1px solid #d1d5db;
      color: var(--text);
      padding: 9px 10px;
      border-radius: 10px;
      outline:none;
      cursor:pointer;
    }
    button:hover{ border-color: #9ca3af; }
    button:active{ transform: translateY(1px); }

    select{
      cursor:pointer;
    }

    .content{
      max-width:1200px;
      margin:0 auto;
      padding:16px;
      display:grid;
      grid-template-columns: 1fr 340px;
      gap:16px;
      align-items:start;
    }

    @media (max-width: 980px){
      .content{ grid-template-columns: 1fr; }
      .side{
        position: static;
        top: auto;
      }
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:14px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 640px){
      .grid{ grid-template-columns: 1fr; }
      .wrap{
        padding: 12px 10px;
      }
      .content{
        padding: 10px;
        gap: 10px;
      }
      .controls{
        justify-content:flex-start;
      }
      .baseMeta{
        align-items:flex-start;
      }
      .chip{
        width:100%;
        justify-content:flex-start;
      }
      button, select, input[type="number"]{
        min-height: 40px;
      }
      .day{
        height: 38px;
        font-size: 14px;
      }
      .month .mhead h2{
        font-size: 13px;
      }
      .side .body{
        padding: 10px;
      }
      .counterHead,
      .counterRow{
        font-size: 11px;
      }
      textarea{
        min-height: 96px;
      }
    }

    .month{
      background: var(--panel);
      border:1px solid #e5e7eb;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .month header{
      position:unset;
      backdrop-filter:none;
      background: transparent;
      border-bottom: 1px solid #eceff3;
    }
    .month .mhead{
      padding: 12px 12px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .month .mhead h2{
      margin:0;
      font-size: 14px;
      letter-spacing:.4px;
      text-transform:uppercase;
      color: var(--text);
    }
    .month .mhead span{
      color: var(--muted);
      font-family: var(--mono);
      font-size: 12px;
    }

    .dow{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 0;
      padding: 0 10px 8px;
      color: var(--muted);
      font-size: 11px;
      text-align:center;
      user-select:none;
    }

    .days{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
      padding: 0 10px 12px;
    }

    .day{
      height: 30px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius: 10px;
      font-size: 12px;
      border:1px solid #e5e7eb;
      background: #ffffff;
      position:relative;
      user-select:none;
      cursor:pointer;
      transition: transform .05s ease, border-color .15s ease, background .15s ease;
    }

    .day:hover{ border-color: #cbd5e1; }
    .day:active{ transform: translateY(1px); }

    .day.mute{
      opacity: .25;
      cursor: default;
    }

    .day.mine{ background: var(--mine); border-color: #e8bcc3; }
    .day.hers{ background: var(--hers); border-color: #e6da9f; }
    .day.neutral{ background: var(--neutral); border-color: #e5e7eb; }

    .badge{
      position:absolute;
      bottom: -4px;
      right: -4px;
      width: 16px; height: 16px;
      border-radius: 6px;
      background: var(--exception);
      border:1px solid #ffffff;
      display:none;
      box-shadow: 0 2px 8px rgba(17,24,39,.16);
    }
    .day.exception .badge{ display:block; }

    .noteDot{
      position:absolute;
      top: -4px;
      left: -4px;
      width: 10px; height: 10px;
      border-radius: 999px;
      background: var(--accent);
      border:1px solid #ffffff;
      display:none;
    }
    .day.hasNote .noteDot{ display:block; }

    .holidayDot{
      position:absolute;
      top: -4px;
      right: -4px;
      width: 10px; height: 10px;
      border-radius: 999px;
      background: var(--holiday);
      border:1px solid #ffffff;
      display:none;
    }
    .day.holiday .holidayDot{ display:block; }

    .vacationDot{
      position:absolute;
      bottom: -4px;
      left: -4px;
      width: 10px; height: 10px;
      border-radius: 999px;
      background: var(--vacation);
      border:1px solid #ffffff;
      display:none;
    }
    .day.vacation .vacationDot{ display:block; }

    .side{
      background: var(--panel);
      border:1px solid #e5e7eb;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:sticky;
      top: 84px;
    }

    .side .shead{
      padding: 12px 12px 10px;
      border-bottom:1px solid #eceff3;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .side .shead h3{ margin:0; font-size:14px; }
    .side .shead small{ color:var(--muted); }

    .side .body{
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .row{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    .seg{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }

    .seg button{
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 12px;
    }

    .seg button.active{
      border-color: #94a3b8;
      background: #eef2f7;
    }

    textarea{
      width:100%;
      min-height:120px;
      resize:vertical;
      background: #ffffff;
      border:1px solid #d1d5db;
      color:var(--text);
      padding:10px;
      border-radius: 12px;
      outline:none;
    }

    .hint{
      font-size: 12px;
      color: var(--muted);
      line-height:1.35;
    }

    .kbd{
      font-family: var(--mono);
      font-size: 11px;
      padding: 2px 6px;
      border: 1px solid #d1d5db;
      border-bottom-color: #c7cdd5;
      border-radius: 8px;
      background: #ffffff;
      color: var(--text);
      display:inline-block;
    }

    .footerActions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }

    .counterWrap{
      margin-top: 6px;
      border:1px solid #e5e7eb;
      border-radius: 12px;
      overflow:hidden;
    }

    .counterHead,
    .counterRow{
      display:grid;
      grid-template-columns: 1.3fr .8fr .8fr .9fr;
      gap:8px;
      padding: 7px 9px;
      font-size: 12px;
      align-items:center;
    }

    .counterHead{
      color: var(--muted);
      font-family: var(--mono);
      background: var(--panel2);
      border-bottom:1px solid #e5e7eb;
    }

    .counterRow{
      border-bottom:1px solid #f1f5f9;
    }

    .counterRow:last-child{
      border-bottom:none;
    }

    .counterRow b{
      color: var(--text);
    }

    .annualOrder{
      margin-top: 8px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
    }

    .danger{ border-color: rgba(255, 77, 77, .35); }
    .danger:hover{ border-color: rgba(255, 77, 77, .7); }

    .fileInput{
      display:none;
    }

    .toast{
      position: fixed;
      bottom: 18px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255,255,255,.98);
      border: 1px solid #d1d5db;
      padding: 10px 12px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      color: var(--text);
      font-size: 13px;
      opacity: 0;
      pointer-events:none;
      transition: opacity .15s ease;
      z-index: 50;
      max-width: 92vw;
    }
    .toast.show{ opacity: 1; }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="topbar">
        <div class="title">
          <div class="titleLine">
            <h1>Calendario de Custodia</h1>
            <small id="status">Guardado local ✅</small>
          </div>
          <div class="baseMeta">
            <span id="baseInfo">Base compartida: pendiente</span>
            <code id="basePath">archivo_base.json</code>
            <a id="baseLink" href="./archivo_base.json" target="_blank" rel="noopener noreferrer">Abrir base</a>
          </div>
        </div>

        <div class="controls">
          <div class="chip" title="Leyenda">
            <span class="dot mine"></span><span>Benja</span>
            <span class="dot hers"></span><span>Charo</span>
            <span class="dot"></span><span>Neutral</span>
            <span class="dot exc"></span><span>Excepción</span>
            <span class="dot holiday"></span><span>Feriado</span>
            <span class="dot vacation"></span><span>Vacación</span>
          </div>

          <label class="chip" title="Año">
            <span>Year</span>
            <input id="yearInput" type="number" min="2000" max="2100" style="width:92px" />
          </label>

          <button id="exportBtn" title="Exportar todo a JSON">Exportar</button>
          <button id="importBtn" title="Importar JSON">Importar</button>
          <input id="fileInput" class="fileInput" type="file" accept="application/json" />
          <button id="resetBtn" class="danger" title="Borrar todo (solo este navegador)">Reset</button>
        </div>
      </div>
    </div>
  </header>

  <div class="content">
    <main>
      <div class="grid" id="monthsGrid"></div>
    </main>

    <aside class="side">
      <div class="shead">
        <div>
          <h3 id="selTitle">Selecciona un día</h3>
          <small id="selDate" style="display:block;margin-top:4px;color:var(--muted);font-family:var(--mono)"></small>
        </div>
        <button id="clearDayBtn" title="Dejar el día neutral y sin excepción">Limpiar día</button>
      </div>

      <div class="body">
        <div class="row">
          <div><b>Asignación</b></div>
          <div class="hint">Click en el día también cicla: Benja → Charo → Neutral</div>
        </div>

        <div class="seg" role="group" aria-label="Asignación">
          <button id="setMineBtn">Benja (rosa)</button>
          <button id="setHersBtn">Charo (amarillo)</button>
          <button id="setNeutralBtn">Neutral</button>
        </div>

        <div class="row">
          <div><b>Excepción</b></div>
          <label style="display:flex; gap:10px; align-items:center;">
            <input id="exceptionChk" type="checkbox" />
            <span>Marcar como excepción</span>
          </label>
        </div>

        <div>
          <b>Nota</b>
          <textarea id="noteInput" placeholder="Ej: Se cambia por viaje / entrega 20:00 / etc."></textarea>
        </div>

        <div class="hint">
          Tips:
          <ul style="margin:8px 0 0 18px; padding:0; color:var(--muted);">
            <li><span class="kbd">Click</span> en un día: cambia asignación (Benja/Charo/Neutral)</li>
            <li><span class="kbd">Shift</span> + <span class="kbd">Click</span>: aplica el mismo cambio a un rango (desde el último día seleccionado)</li>
            <li>Punto celeste = nota, punto naranjo = feriado legal, punto verde = vacaciones</li>
          </ul>
        </div>

        <div>
          <b>Contador mensual</b>
          <div class="hint">Días por mes en orden + acumulado anual.</div>
          <div id="monthlyCounter" class="counterWrap"></div>
          <div id="annualOrder" class="annualOrder"></div>
        </div>

        <div class="footerActions">
          <button id="todayBtn" title="Ir al día de hoy">Hoy</button>
          <button id="printBtn" title="Imprimir (usa el diálogo del navegador)">Imprimir</button>
        </div>
      </div>
    </aside>
  </div>

  <div class="toast" id="toast"></div>

<script>
(() => {
  const STORAGE_KEY = "custodia_calendar_v1";
  const BASE_STATE_FILE = "./archivo_base.json";
  const IMAGE_PLAN_YEAR = 2026;
  const MONTHS = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
  const DOW = ["L","M","X","J","V","S","D"];
  const LEGAL_HOLIDAYS = {
    2026: [
      {iso:"2026-01-01", name:"Año Nuevo"},
      {iso:"2026-04-03", name:"Viernes Santo"},
      {iso:"2026-04-04", name:"Sábado Santo"},
      {iso:"2026-05-01", name:"Día del Trabajo"},
      {iso:"2026-05-21", name:"Glorias Navales"},
      {iso:"2026-06-21", name:"Pueblos Indígenas"},
      {iso:"2026-06-29", name:"San Pedro y San Pablo"},
      {iso:"2026-07-16", name:"Virgen del Carmen"},
      {iso:"2026-08-15", name:"Asunción de la Virgen"},
      {iso:"2026-09-18", name:"Independencia Nacional"},
      {iso:"2026-09-19", name:"Glorias del Ejército"},
      {iso:"2026-10-12", name:"Encuentro de Dos Mundos"},
      {iso:"2026-10-31", name:"Iglesias Evangélicas"},
      {iso:"2026-11-01", name:"Todos los Santos"},
      {iso:"2026-12-08", name:"Inmaculada Concepción"},
      {iso:"2026-12-25", name:"Navidad"}
    ]
  };
  const VACATION_RANGES = {
    2026: [
      {from:"2026-06-22", to:"2026-07-05", name:"Vacaciones de invierno"}
    ]
  };

  // Preset base 2026 (rosa = Benja, amarillo = Charo) tomado de la planificación de referencia.
  // Cada arreglo contiene los días de mes que parten asignados a "Benja" (rosa).
  const DEFAULT_PRESET_MINE_DAYS_2026 = {
    1: [1,2,3,4,6,8,11,12,14,16,17,19,20,21,26,28,30,31],
    2: [1,5,6,7,8,9,11,16,18,20,21,22,24,26],
    3: [2,4,6,7,8,10,12,16,18,20,21,22,24,26,28,30],
    4: [1,3,4,5,7,9,13,15,17,18,19,21,23,27,29],
    5: [2,3,5,7,11,13,15,16,17,19,21,25,27,29,30,31],
    6: [2,4,8,10,12,13,14,16,18,22,24,26,27,28,30],
    7: [2,6,8,10,11,12,14,16,20,22,24,25,26,28,30],
    8: [3,5,7,8,9,11,13,17,19,21,22,23,25,27,31],
    9: [2,4,5,6,8,10,12,14,16,18,19,20,22,24,28,30],
    10:[2,3,4,6,8,12,14,16,17,18,20,22,26,28,30,31],
    11:[1,3,5,9,11,13,14,15,17,19,23,25,27,28,29,30],
    12:[2,4,5,6,8,10,14,16,18,19,20,22,24,29,31]
  };

  let state = loadState();
  if (!state || state.year !== IMAGE_PLAN_YEAR) {
    state = makeDefaultPresetState(IMAGE_PLAN_YEAR);
  }
  let baseFileState = null;
  let selected = null;
  let lastSelected = null;
  let lastCycleOwner = null;

  const monthsGrid = document.getElementById("monthsGrid");
  const yearInput = document.getElementById("yearInput");
  const statusEl = document.getElementById("status");
  const baseInfoEl = document.getElementById("baseInfo");
  const basePathEl = document.getElementById("basePath");
  const baseLinkEl = document.getElementById("baseLink");
  const selTitle = document.getElementById("selTitle");
  const selDate = document.getElementById("selDate");
  const setMineBtn = document.getElementById("setMineBtn");
  const setHersBtn = document.getElementById("setHersBtn");
  const setNeutralBtn = document.getElementById("setNeutralBtn");
  const clearDayBtn = document.getElementById("clearDayBtn");
  const exceptionChk = document.getElementById("exceptionChk");
  const noteInput = document.getElementById("noteInput");
  const exportBtn = document.getElementById("exportBtn");
  const importBtn = document.getElementById("importBtn");
  const fileInput = document.getElementById("fileInput");
  const resetBtn = document.getElementById("resetBtn");
  const todayBtn = document.getElementById("todayBtn");
  const printBtn = document.getElementById("printBtn");
  const toast = document.getElementById("toast");
  const monthlyCounter = document.getElementById("monthlyCounter");
  const annualOrder = document.getElementById("annualOrder");

  yearInput.value = state.year;
  renderYear(state.year);
  setBaseUi("Cargando base compartida...", false);
  initializeFromBaseFile();

  const t = new Date();
  if (t.getFullYear() === state.year) {
    selectDay(toISO(t));
    scrollToMonth(t.getMonth());
  }

  yearInput.addEventListener("change", () => {
    const y = clamp(parseInt(yearInput.value, 10) || IMAGE_PLAN_YEAR, 2000, 2100);
    state = (y === IMAGE_PLAN_YEAR)
      ? (baseFileState ? cloneState(baseFileState) : makeDefaultPresetState(y))
      : makeEmptyState(y);
    persist();
    renderYear(y);
    selected = null;
    lastSelected = null;
    refreshSidePanel();
    renderMonthlyCounter();
    toastMsg("Año cambiado. Estado nuevo creado para " + y);
  });

  setMineBtn.addEventListener("click", () => setOwnerForSelection("mine"));
  setHersBtn.addEventListener("click", () => setOwnerForSelection("hers"));
  setNeutralBtn.addEventListener("click", () => setOwnerForSelection("neutral"));

  clearDayBtn.addEventListener("click", () => {
    if (!selected) return;
    delete state.days[selected];
    persist();
    updateDayCell(selected);
    refreshSidePanel();
    renderMonthlyCounter();
    toastMsg("Día limpiado");
  });

  exceptionChk.addEventListener("change", () => {
    if (!selected) return;
    const d = ensureDay(selected);
    d.exception = !!exceptionChk.checked;
    persist();
    updateDayCell(selected);
  });

  noteInput.addEventListener("input", () => {
    if (!selected) return;
    const txt = noteInput.value.trim();
    if (txt.length === 0) {
      const existing = state.days[selected];
      if (existing) {
        existing.note = "";
        cleanupDay(selected);
        persist();
        updateDayCell(selected);
      }
      return;
    }
    const d = ensureDay(selected);
    d.note = txt;
    persistDebounced();
    updateDayCell(selected);
  });

  exportBtn.addEventListener("click", () => {
    const blob = new Blob([JSON.stringify(state, null, 2)], {type: "application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `custodia_${state.year}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
    toastMsg("Exportado ✅");
  });

  importBtn.addEventListener("click", () => fileInput.click());

  fileInput.addEventListener("change", async () => {
    const file = fileInput.files?.[0];
    if (!file) return;
    try{
      const txt = await file.text();
      const obj = JSON.parse(txt);
      if (!obj || typeof obj !== "object" || !obj.year || !obj.days) throw new Error("Formato inválido");
      state = sanitizeState(obj);
      yearInput.value = state.year;
      persist();
      renderYear(state.year);
      selected = null;
      lastSelected = null;
      refreshSidePanel();
      renderMonthlyCounter();
      toastMsg("Importado ✅");
    }catch(e){
      toastMsg("No se pudo importar: " + e.message);
    } finally {
      fileInput.value = "";
    }
  });

  resetBtn.addEventListener("click", () => {
    if (!confirm("¿Seguro? Esto borrará todo lo guardado en este navegador para este calendario.")) return;
    localStorage.removeItem(STORAGE_KEY);
    const y = parseInt(yearInput.value, 10) || IMAGE_PLAN_YEAR;
    state = (y === IMAGE_PLAN_YEAR)
      ? (baseFileState ? cloneState(baseFileState) : makeDefaultPresetState(y))
      : makeEmptyState(y);
    persist();
    renderYear(state.year);
    selected = null;
    lastSelected = null;
    refreshSidePanel();
    renderMonthlyCounter();
    toastMsg("Reset realizado");
  });

  todayBtn.addEventListener("click", () => {
    const now = new Date();
    if (now.getFullYear() !== state.year) {
      toastMsg("El 'hoy' no está en el año seleccionado");
      return;
    }
    selectDay(toISO(now));
    scrollToMonth(now.getMonth());
  });

  printBtn.addEventListener("click", () => window.print());

  function renderYear(year){
    const holidayMap = getHolidayMap(year);
    const vacationSet = getVacationSet(year);
    monthsGrid.innerHTML = "";
    for (let m=0; m<12; m++){
      const card = document.createElement("section");
      card.className = "month";
      card.dataset.month = String(m);

      const head = document.createElement("header");
      const mhead = document.createElement("div");
      mhead.className = "mhead";
      const h2 = document.createElement("h2");
      h2.textContent = MONTHS[m];
      const span = document.createElement("span");
      span.textContent = "Q" + (Math.floor(m/3)+1);
      mhead.appendChild(h2);
      mhead.appendChild(span);
      head.appendChild(mhead);
      card.appendChild(head);

      const dow = document.createElement("div");
      dow.className = "dow";
      DOW.forEach(d => {
        const el = document.createElement("div");
        el.textContent = d;
        dow.appendChild(el);
      });
      card.appendChild(dow);

      const days = document.createElement("div");
      days.className = "days";

      const {leadingBlanks, numDays} = monthMeta(year, m);

      for (let i=0; i<leadingBlanks; i++){
        const blank = document.createElement("div");
        blank.className = "day mute";
        blank.textContent = "";
        days.appendChild(blank);
      }

      for (let d=1; d<=numDays; d++){
        const iso = toISO(new Date(year, m, d));
        const cell = document.createElement("div");
        cell.className = "day neutral";
        cell.dataset.iso = iso;
        cell.textContent = String(d);

        const badge = document.createElement("div");
        badge.className = "badge";
        cell.appendChild(badge);

        const noteDot = document.createElement("div");
        noteDot.className = "noteDot";
        cell.appendChild(noteDot);

        const holidayDot = document.createElement("div");
        holidayDot.className = "holidayDot";
        cell.appendChild(holidayDot);

        const vacationDot = document.createElement("div");
        vacationDot.className = "vacationDot";
        cell.appendChild(vacationDot);

        if (holidayMap.has(iso)) cell.classList.add("holiday");
        if (vacationSet.has(iso)) cell.classList.add("vacation");
        updateDayTooltip(iso, cell);

        cell.addEventListener("click", (ev) => {
          const isShift = ev.shiftKey;
          if (isShift && lastSelected) {
            const from = lastSelected;
            const to = iso;
            applyRangeCycle(from, to);
          } else {
            cycleOwner(iso);
            selectDay(iso);
            lastSelected = iso;
            renderMonthlyCounter();
          }
        });

        days.appendChild(cell);
      }

      card.appendChild(days);
      monthsGrid.appendChild(card);
    }

    Object.keys(state.days).forEach(iso => updateDayCell(iso));
    refreshSidePanel();
    renderMonthlyCounter();
  }

  function updateDayCell(iso){
    const cell = monthsGrid.querySelector(`.day[data-iso="${cssEscape(iso)}"]`);
    if (!cell) return;

    cell.classList.remove("mine","hers","neutral","exception","hasNote","selected");

    const entry = state.days[iso];
    const owner = entry?.owner || "neutral";

    cell.classList.add(owner === "mine" ? "mine" : owner === "hers" ? "hers" : "neutral");
    if (entry?.exception) cell.classList.add("exception");
    if (entry?.note && entry.note.trim().length > 0) cell.classList.add("hasNote");
    updateDayTooltip(iso, cell);

    if (selected === iso) {
      cell.style.outline = "2px solid var(--select)";
      cell.style.outlineOffset = "2px";
    } else {
      cell.style.outline = "none";
      cell.style.outlineOffset = "0";
    }
  }

  function selectDay(iso){
    selected = iso;
    monthsGrid.querySelectorAll('.day[data-iso]').forEach(el => {
      const thisIso = el.dataset.iso;
      if (thisIso === iso) {
        el.style.outline = "2px solid var(--select)";
        el.style.outlineOffset = "2px";
      } else {
        el.style.outline = "none";
        el.style.outlineOffset = "0";
      }
    });
    refreshSidePanel();
  }

  function refreshSidePanel(){
    if (!selected){
      selTitle.textContent = "Selecciona un día";
      selDate.textContent = "";
      exceptionChk.checked = false;
      noteInput.value = "";
      setMineBtn.classList.remove("active");
      setHersBtn.classList.remove("active");
      setNeutralBtn.classList.remove("active");
      return;
    }

    const entry = state.days[selected] || {owner:"neutral", exception:false, note:""};
    const owner = entry.owner || "neutral";

    selTitle.textContent = "Editar día";
    selDate.textContent = selected;

    exceptionChk.checked = !!entry.exception;
    noteInput.value = entry.note || "";

    setMineBtn.classList.toggle("active", owner === "mine");
    setHersBtn.classList.toggle("active", owner === "hers");
    setNeutralBtn.classList.toggle("active", owner === "neutral");
  }

  function cycleOwner(iso){
    const entry = ensureDay(iso);
    const current = entry.owner || "neutral";
    const next = current === "neutral" ? "mine" : current === "mine" ? "hers" : "neutral";
    entry.owner = next;
    lastCycleOwner = next;
    cleanupDay(iso);
    persist();
    updateDayCell(iso);
  }

  function setOwner(iso, owner){
    const entry = ensureDay(iso);
    entry.owner = owner;
    cleanupDay(iso);
    persist();
    updateDayCell(iso);
  }

  function setOwnerForSelection(owner){
    if (!selected) return;
    setOwner(selected, owner);
    refreshSidePanel();
    renderMonthlyCounter();
    toastMsg("Asignado: " + (owner === "mine" ? "Benja" : owner === "hers" ? "Charo" : "Neutral"));
  }

  function applyRangeCycle(fromIso, toIso){
    const [a, b] = fromIso <= toIso ? [fromIso, toIso] : [toIso, fromIso];
    const dates = listDatesInclusive(a, b);
    dates.forEach(iso => cycleOwner(iso));
    selectDay(toIso);
    lastSelected = toIso;
    renderMonthlyCounter();
    toastMsg(`Rango aplicado (${dates.length} días)`);
  }

  function renderMonthlyCounter(){
    const totals = computeOwnerTotals();
    const rows = [];
    let accMine = 0;
    let accHers = 0;
    for (let m=0; m<12; m++){
      let mine = 0;
      let hers = 0;
      const numDays = new Date(state.year, m + 1, 0).getDate();
      for (let d=1; d<=numDays; d++){
        const iso = `${state.year}-${String(m + 1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
        const owner = getOwner(iso);
        if (owner === "mine") mine += 1;
        else if (owner === "hers") hers += 1;
      }
      accMine += mine;
      accHers += hers;
      rows.push(`
        <div class="counterRow">
          <b>${MONTHS[m]}</b>
          <span>${mine}</span>
          <span>${hers}</span>
          <span>${accMine} / ${accHers}</span>
        </div>
      `);
    }

    monthlyCounter.innerHTML = `
      <div class="counterHead">
        <span>Mes</span>
        <span>Benja</span>
        <span>Charo</span>
        <span>Acum.</span>
      </div>
      ${rows.join("")}
    `;

    let lider = "Empate";
    if (totals.mine > totals.hers) lider = "Vas arriba";
    if (totals.hers > totals.mine) lider = "Charo va arriba";
    annualOrder.textContent = `Orden anual: Benja ${totals.mine} | Charo ${totals.hers} | Neutral ${totals.neutral} (${lider})`;
  }

  let persistTimer = null;

  function persistDebounced(){
    clearTimeout(persistTimer);
    persistTimer = setTimeout(() => persist(), 250);
  }

  function persist(){
    try{
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      statusEl.textContent = "Guardado local ✅";
    }catch(e){
      statusEl.textContent = "No se pudo guardar ⚠️";
    }
  }

  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return null;
      return sanitizeState(JSON.parse(raw));
    }catch(e){
      return null;
    }
  }

  async function initializeFromBaseFile(){
    try{
      const baseUrl = new URL(BASE_STATE_FILE, window.location.href).href;
      const res = await fetch(baseUrl, { cache: "no-store" });
      if (!res.ok) throw new Error("No se encontró archivo_base.json");
      const obj = await res.json();
      const parsed = sanitizeState(obj);
      if (!parsed || parsed.year !== IMAGE_PLAN_YEAR) {
        throw new Error("archivo_base.json no corresponde al año base");
      }
      baseFileState = parsed;
      state = cloneState(parsed);
      yearInput.value = state.year;
      persist();
      renderYear(state.year);
      selected = null;
      lastSelected = null;
      refreshSidePanel();
      renderMonthlyCounter();
      statusEl.textContent = "Base cargada desde archivo_base.json ✅";
      setBaseUi("Base compartida activa para todos", true, baseUrl);
      toastMsg("Base 2026 cargada");
    }catch(e){
      statusEl.textContent = "Usando base local ⚠️";
      setBaseUi("No se pudo cargar archivo_base.json", false);
    }
  }

  function sanitizeState(obj){
    const year = clamp(parseInt(obj.year,10) || IMAGE_PLAN_YEAR, 2000, 2100);
    const days = (obj.days && typeof obj.days === "object") ? obj.days : {};
    const cleanDays = {};
    for (const [iso, v] of Object.entries(days)){
      if (!/^\d{4}-\d{2}-\d{2}$/.test(iso)) continue;
      const owner = (v?.owner === "mine" || v?.owner === "hers" || v?.owner === "neutral") ? v.owner : "neutral";
      const exception = !!v?.exception;
      const note = typeof v?.note === "string" ? v.note.slice(0, 2000) : "";
      if (owner === "neutral" && !exception && note.trim() === "") continue;
      cleanDays[iso] = {owner, exception, note};
    }
    return {year, days: cleanDays};
  }

  function makeEmptyState(year){
    return { year, days: {} };
  }

  function makeDefaultPresetState(year){
    const base = makeEmptyState(year);
    if (year !== 2026) return base;
    for (let m=1; m<=12; m++){
      const mineDays = new Set(DEFAULT_PRESET_MINE_DAYS_2026[m] || []);
      const numDays = new Date(year, m, 0).getDate();
      for (let d=1; d<=numDays; d++){
        const iso = `${year}-${String(m).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
        base.days[iso] = { owner: mineDays.has(d) ? "mine" : "hers", exception: false, note: "" };
      }
    }
    return base;
  }

  function cloneState(obj){
    return JSON.parse(JSON.stringify(obj));
  }

  function setBaseUi(label, loaded, url){
    baseInfoEl.textContent = label;
    const finalUrl = url || BASE_STATE_FILE;
    basePathEl.textContent = finalUrl;
    baseLinkEl.href = finalUrl;
    baseLinkEl.textContent = loaded ? "Abrir base (misma fuente)" : "Abrir base";
  }

  function getOwner(iso){
    return state.days[iso]?.owner || "neutral";
  }

  function computeOwnerTotals(){
    let mine = 0;
    let hers = 0;
    let neutral = 0;
    for (let m=0; m<12; m++){
      const numDays = new Date(state.year, m + 1, 0).getDate();
      for (let d=1; d<=numDays; d++){
        const iso = `${state.year}-${String(m + 1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
        const owner = getOwner(iso);
        if (owner === "mine") mine += 1;
        else if (owner === "hers") hers += 1;
        else neutral += 1;
      }
    }
    return {mine, hers, neutral};
  }

  function getHolidayMap(year){
    const entries = LEGAL_HOLIDAYS[year] || [];
    const map = new Map();
    entries.forEach(item => map.set(item.iso, item.name));
    return map;
  }

  function getVacationSet(year){
    const set = new Set();
    const ranges = VACATION_RANGES[year] || [];
    ranges.forEach(range => {
      listDatesInclusive(range.from, range.to).forEach(iso => set.add(iso));
    });
    return set;
  }

  function ownerLabel(owner){
    if (owner === "mine") return "Benja";
    if (owner === "hers") return "Charo";
    return "Neutral";
  }

  function updateDayTooltip(iso, cell){
    const el = cell || monthsGrid.querySelector(`.day[data-iso="${cssEscape(iso)}"]`);
    if (!el) return;
    const entry = state.days[iso] || { owner:"neutral", exception:false, note:"" };
    const holidayName = getHolidayMap(state.year).get(iso);
    const isVacation = getVacationSet(state.year).has(iso);
    const lines = [
      iso,
      `Pertenece a: ${ownerLabel(entry.owner)}`
    ];
    if (entry.note && entry.note.trim().length > 0) lines.push(`Nota: ${entry.note.trim()}`);
    if (entry.exception) lines.push("Excepción: Sí");
    if (holidayName) lines.push(`Feriado: ${holidayName}`);
    if (isVacation) lines.push("Vacaciones");
    el.title = lines.join("\n");
  }

  function cleanupDay(iso){
    const v = state.days[iso];
    if (!v) return;
    const owner = v.owner || "neutral";
    const exception = !!v.exception;
    const note = (v.note || "").trim();
    if (owner === "neutral" && !exception && note === "") {
      delete state.days[iso];
    } else {
      v.owner = owner;
      v.exception = exception;
      v.note = note;
    }
  }

  function ensureDay(iso){
    if (!state.days[iso]) state.days[iso] = { owner:"neutral", exception:false, note:"" };
    return state.days[iso];
  }

  function monthMeta(year, monthIdx){
    const first = new Date(year, monthIdx, 1);
    const jsDay = first.getDay();
    const mondayIndex = (jsDay + 6) % 7;
    const numDays = new Date(year, monthIdx + 1, 0).getDate();
    return { leadingBlanks: mondayIndex, numDays };
  }

  function toISO(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  }

  function listDatesInclusive(fromIso, toIso){
    const res = [];
    const start = parseISO(fromIso);
    const end = parseISO(toIso);
    for (let d = new Date(start); d <= end; d.setDate(d.getDate()+1)){
      res.push(toISO(d));
    }
    return res;
  }

  function parseISO(iso){
    const [y,m,d] = iso.split("-").map(n => parseInt(n,10));
    return new Date(y, m-1, d);
  }

  function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

  function scrollToMonth(monthIdx){
    const el = monthsGrid.querySelector(`.month[data-month="${monthIdx}"]`);
    if (!el) return;
    el.scrollIntoView({behavior:"smooth", block:"start"});
  }

  function toastMsg(msg){
    toast.textContent = msg;
    toast.classList.add("show");
    setTimeout(() => toast.classList.remove("show"), 1500);
  }

  function cssEscape(str){
    return str.replace(/"/g,'\\"');
  }
})();
</script>
</body>
</html>
